services:
  m3u4prox:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILDPLATFORM=linux/amd64
    platform: linux/amd64
    container_name: m3u4prox
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    ports:
      - "${PORT:-3005}:3005"
      - "${HDHR_PORT:-5004}:5004"      # HDHomeRun virtual tuner (Plex/Emby/Jellyfin)
      - "${PRIVOXY_PORT:-8118}:8118"   # Privoxy (only needed if PRIVOXY_ENABLED=true)
    volumes:
      - ./data:/data                      # All application data (DB, output, EPG, configs, etc.)
    environment:
      - PUID=${PUID:-99}
      - PGID=${PGID:-100}
      - PORT=3005
      - DATA_DIR=/data
      - EPG_GRAB_DAYS=${EPG_GRAB_DAYS:-3}
      - EPG_GRAB_DELAY=${EPG_GRAB_DELAY:-500}
      - EPG_GRAB_TIMEOUT=${EPG_GRAB_TIMEOUT:-15000}
      - EPG_GRAB_CONNECTIONS=${EPG_GRAB_CONNECTIONS:-4}
      - DNS_SERVERS=${DNS_SERVERS:-1.1.1.1,8.8.8.8}
      - HOST_IP=${HOST_IP:-}

      # ── VPN ──────────────────────────────────────────────────────────────────
      - VPN_DIR=/data/config/openvpn
      - VPN_LOG_DIR=/data/logs/openvpn
      - PRIVOXY_LOG_DIR=/data/logs/privoxy
      - VPN_ENABLED=${VPN_ENABLED:-false}
      # Supported: CUSTOM, PIA, SURFSHARK, IPVANISH, NORDVPN, VYPRVPN, PROTONVPN
      - OPENVPN_PROVIDER=${OPENVPN_PROVIDER:-CUSTOM}
      # Specific config file (optional — omit to use first .ovpn found)
      - OPENVPN_CONFIG=${OPENVPN_CONFIG:-}
      - OPENVPN_PROTOCOL=${OPENVPN_PROTOCOL:-udp}
      - OPENVPN_USERNAME=${OPENVPN_USERNAME:-}
      - OPENVPN_PASSWORD=${OPENVPN_PASSWORD:-}
      # Extra openvpn CLI flags — redirect-gateway def1 routes all traffic through VPN
      - OPENVPN_OPTIONS=${OPENVPN_OPTIONS:---redirect-gateway def1}
      # Set true to force re-download of provider configs on next start
      - OPENVPN_FORCE_UPDATE=${OPENVPN_FORCE_UPDATE:-false}

      # ── DNS / routing ─────────────────────────────────────────────────────────
      # Comma-separated DNS servers (optional)
      - NAME_SERVERS=
      # Comma-separated CIDRs to route outside the tunnel (optional)
      - LOCAL_NETWORK=${LOCAL_NETWORK:-}

      # ── Privoxy ───────────────────────────────────────────────────────────────
      - PRIVOXY_ENABLED=${PRIVOXY_ENABLED:-false}
      - PRIVOXY_PORT=${PRIVOXY_PORT:-8118}

      # ── App ─────────────────────────────────────────────────────────────────────────
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
      - TMDB_API_KEY=${TMDB_API_KEY:-}
      - PROXY_BUFFER_SECONDS=${PROXY_BUFFER_SECONDS:-0}

      # ── Debug ─────────────────────────────────────────────────────────────────────────
      - DEBUG=${DEBUG:-false}
    dns:
      - ${DNS_SERVER_1:-1.1.1.1}
      - ${DNS_SERVER_2:-8.8.8.8}
    restart: unless-stopped
